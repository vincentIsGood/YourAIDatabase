<html>
    <head>
        <!-- For me: This is a very rough Web-App implementation. Scale it up if needed. -->
        <link rel="stylesheet" href="style.css">
        <script type="module">
            let lock = false;
            let sources = new Set();
            let jobId = "";
            function queryAiDatabase(query){
                query = query.trim();
                if(query == "" || lock) return;

                lock = true;
                fetch("/aidb?query=" + encodeURIComponent(query))
                .then(res => res.text()).then(res =>{
                    if(res == ""){
                        createChatMessageDiv("Server returned empty response. Please keep waiting.", false);
                        return;
                    }
                    jobId = res;

                    const websocket = new WebSocket("ws://localhost:5023");
                    window.websocket = websocket;

                    let assistantDiv = null;
                    let currentMsgState = "";

                    websocket.addEventListener("open", ()=>{
                        websocket.send(JSON.stringify({"id": res}));
                        createChatMessageDiv(query, true);
                        assistantDiv = createChatMessageDiv("", false);
                    });
                    websocket.addEventListener("message", (event)=>{
                        switch(event.data){
                            case "[[[START]]]": 
                                document.querySelector("#stop").classList.remove("display-none");
                                currentMsgState = "response"; 
                            break;
                            case "[[[SOURCES]]]": 
                                currentMsgState = "sources";
                            break;
                            case "[[[END]]]": 
                                currentMsgState = "";
                                lock = false;
                                websocket.close();
                            break;
                            default:
                                if(currentMsgState == "response")
                                    assistantDiv.textContent += event.data;
                                else if(currentMsgState == "sources"){
                                    let sourceText = JSON.parse(event.data)["source"];
                                    if(!sources.has(sourceText)){
                                        sources.add(sourceText);
                                        createSource(sourceText);
                                    }
                                }
                        }
                    });
                    websocket.addEventListener("close", (event)=>{
                        document.querySelector("#stop").classList.add("display-none");
                        lock = false;
                    });
                });
            }
            function stopGeneration(){
                fetch("/aidb?id=" + encodeURIComponent(jobId), {
                    method: "DELETE"
                });
            }
            function createChatMessageDiv(message, isUser = true){
                const divElement = document.createElement("div");
                const contentElement = document.createElement("div");
                if(isUser) divElement.classList.add("user");
                else divElement.classList.add("assistant");
                contentElement.classList.add("content");
                contentElement.textContent = message;
                divElement.appendChild(contentElement);
                document.querySelector(".conversation").appendChild(divElement);
                return contentElement;
            }
            function createSource(source){
                const sourceDiv = document.createElement("div");
                sourceDiv.classList.add("source");
                sourceDiv.textContent = source;
                document.querySelector(".sources").appendChild(sourceDiv);
            }

            window.addEventListener("load", ()=>{
                const userInputField = document.querySelector("#user-input");
                userInputField.addEventListener("keydown", (e)=>{
                    if(e.key == "Enter"){
                        queryAiDatabase(userInputField.value);
                        userInputField.value = "";
                        queryButton.classList.add("display-none");
                    }
                });
                userInputField.addEventListener("input", ()=>{
                    if(userInputField.value.length > 0)
                        queryButton.classList.remove("display-none");
                    else queryButton.classList.add("display-none");
                });

                const queryButton = document.querySelector("#query");
                queryButton.addEventListener("click", ()=>{
                    queryAiDatabase(userInputField.value);
                });
                
                const stopButton = document.querySelector("#stop");
                stopButton.addEventListener("click", ()=>{
                    stopGeneration();
                });
            });
        </script>
    </head>
    <body>
        <div class="chat-window">
            <div class="title">Your AI Database</div>
            <div class="chat-history">
                <div class="conversation"></div>
                <div class="input-box-wrapper">
                    <input type="text" id="user-input">
                    <button id="query" class="display-none">Query</button>
                    <button id="stop" class="display-none">Stop</button>
                </div>
            </div>
            <div class="sources"></div>
        </div>
        <!-- Import stuff -->
        <!-- View Imported Documents  -->
    </body>
</html>