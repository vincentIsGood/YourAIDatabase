<html>
    <head>
        <!-- For me: This is a very rough Web-App implementation. Scale it up if needed. -->
        <link rel="stylesheet" href="style.css">
        <script type="module">
            let lock = false;
            let sources = new Set();
            let jobId = "";
            function queryAiDatabase(query){
                query = query.trim();
                if(query == "" || lock) return;

                lock = true;
                fetch("/aidb?query=" + encodeURIComponent(query))
                .then(res => res.text()).then(res =>{
                    if(res == ""){
                        createChatMessageDiv("Server returned empty response. Please keep waiting.", false);
                        return;
                    }
                    jobId = res;

                    const websocket = new WebSocket("ws://localhost:5023");
                    window.websocket = websocket;

                    let assistantDiv = null;
                    let currentMsgState = "";

                    websocket.addEventListener("open", ()=>{
                        websocket.send(JSON.stringify({"id": res}));
                        createChatMessageDiv(query, true);
                        assistantDiv = createChatMessageDiv("", false);
                    });
                    websocket.addEventListener("message", (event)=>{
                        switch(event.data){
                            case "[[[START]]]": 
                                document.querySelector("#stop").classList.remove("display-none");
                                currentMsgState = "response"; 
                            break;
                            case "[[[SOURCES]]]": 
                                currentMsgState = "sources";
                            break;
                            case "[[[END]]]": 
                                currentMsgState = "";
                                lock = false;
                                websocket.close();
                            break;
                            default:
                                if(currentMsgState == "response")
                                    assistantDiv.textContent += event.data;
                                else if(currentMsgState == "sources"){
                                    let sourceText = JSON.parse(event.data)["source"];
                                    if(!sources.has(sourceText)){
                                        sources.add(sourceText);
                                        createSource(sourceText);
                                    }
                                }
                        }
                    });
                    websocket.addEventListener("close", (event)=>{
                        document.querySelector("#stop").classList.add("display-none");
                        lock = false;
                    });
                });
            }
            function stopGeneration(){
                fetch("/aidb?id=" + encodeURIComponent(jobId), {
                    method: "DELETE"
                });
            }
            function createChatMessageDiv(message, isUser = true){
                const divElement = document.createElement("div");
                const contentElement = document.createElement("div");
                if(isUser) divElement.classList.add("user");
                else divElement.classList.add("assistant");
                contentElement.classList.add("content");
                contentElement.textContent = message;
                divElement.appendChild(contentElement);
                document.querySelector(".conversation").appendChild(divElement);
                return contentElement;
            }
            function createSource(source){
                const sourceDiv = document.createElement("a");
                sourceDiv.classList.add("source");
                sourceDiv.textContent = source;
                sourceDiv.href = source;
                document.querySelector(".sources").appendChild(sourceDiv);
            }

            window.addEventListener("load", ()=>{
                /**
                 * @type {HTMLDivElement}
                 */
                const dragNDropUploadField = document.querySelector(".drag-n-drop");
                const dragNDropStatusMsg = document.querySelector(".drag-n-drop .status");
                const addIcon = document.querySelector(".add-icon");
                const uploadIcon = document.querySelector(".upload-icon");
                dragNDropUploadField.addEventListener("drop", async (e)=>{
                    e.preventDefault();
                    for(let droppedItem of e.dataTransfer.items){
                        // Bad performance. But to keep stuff simple, I'll leave it.
                        if(droppedItem.kind == "file"){
                            const file = droppedItem.getAsFile();
                            dragNDropStatusMsg.textContent = "Uploading...";
                            fetch("/aidb/upload?name=" + file.name, {
                                method: "POST", 
                                body: await file.arrayBuffer(),
                                headers: {
                                    "content-type": file.type
                                }
                            }).then(()=>{
                                dragNDropStatusMsg.textContent = "Uploaded";
                            }).catch(()=>{
                                dragNDropStatusMsg.textContent = "Error Encountered";
                            });
                        }
                    }
                    setTimeout(()=>{
                        addIcon.classList.remove("display-none");
                        uploadIcon.classList.add("display-none");
                        dragNDropStatusMsg.textContent = "Drop files here";
                    }, 1000);
                });
                dragNDropUploadField.addEventListener("dragover", (e)=>{
                    e.preventDefault();
                    addIcon.classList.add("display-none");
                    uploadIcon.classList.remove("display-none");
                    dragNDropStatusMsg.textContent = "Upload";
                });
                dragNDropUploadField.addEventListener("dragleave", (e)=>{
                    e.preventDefault();
                    addIcon.classList.remove("display-none");
                    uploadIcon.classList.add("display-none");
                    dragNDropStatusMsg.textContent = "Drop files here";
                });

                const userInputField = document.querySelector("#user-input");
                userInputField.addEventListener("keydown", (e)=>{
                    if(e.key == "Enter"){
                        queryAiDatabase(userInputField.value);
                        userInputField.value = "";
                        queryButton.classList.add("display-none");
                    }
                });
                userInputField.addEventListener("input", ()=>{
                    if(userInputField.value.length > 0)
                        queryButton.classList.remove("display-none");
                    else queryButton.classList.add("display-none");
                });

                const queryButton = document.querySelector("#query");
                queryButton.addEventListener("click", ()=>{
                    queryAiDatabase(userInputField.value);
                });
                
                const stopButton = document.querySelector("#stop");
                stopButton.addEventListener("click", ()=>{
                    stopGeneration();
                });
            });
        </script>
    </head>
    <body>
        <div class="main-content">
            <div class="upload-wrapper">
                <div class="upload-panel">
                    <div class="title">Document Upload</div>
                    <div class="dragndrop-wrapper">
                        <div class="drag-n-drop">
                            <svg class="add-icon" viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" /></svg>
                            <svg class="upload-icon display-none" viewBox="0 0 24 24"><path d="M14 2H6C4.89 2 4 2.89 4 4V20C4 21.11 4.89 22 6 22H13.81C13.28 21.09 13 20.05 13 19C13 15.69 15.69 13 19 13C19.34 13 19.67 13.03 20 13.08V8L14 2M13 9V3.5L18.5 9H13M23 20H20V23H18V20H15V18H18V15H20V18H23V20Z" /></svg>
                            <div class="status">Drop files here</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chat-window">
                <div class="title">Your AI Database</div>
                <div class="chat-history">
                    <div class="conversation"></div>
                    <div class="input-box-wrapper">
                        <input type="text" id="user-input" placeholder="Type your query here">
                        <button id="query" class="display-none">Query</button>
                        <button id="stop" class="display-none">Stop</button>
                    </div>
                </div>
                <div class="sources"></div>
            </div>
        </div>
        <!-- Import stuff -->
        <!-- View Imported Documents  -->
    </body>
</html>